# Copyright 2025 Matheus Pimenta.
# SPDX-License-Identifier: AGPL-3.0

name: upgrade-gcloud

on:
  schedule:
  - cron: "0 8 * * 2" # every Tuesday
  workflow_dispatch:

jobs:
  upgrade:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        token: ${{ secrets.BOT_GITHUB_TOKEN }}
        persist-credentials: false

    - name: Set up crane
      uses: imjasonh/setup-crane@6da1ae018866400525525ce74ff892880c099987 # v0.5

    - name: Get latest gcloud CLI slim tag
      id: release
      run: |
        tag=$(crane ls google/cloud-sdk | grep -E '^[0-9]+\.[0-9]+\.[0-9]+-slim$' | sort -V | tail -1)
        echo "tag=$tag" >> "$GITHUB_OUTPUT"

    - name: Update testdata
      env:
        TAG: ${{ steps.release.outputs.tag }}
      run: |
        sed -i "s|image: google/cloud-sdk:.*|image: google/cloud-sdk:${TAG}|" testdata/pod-gcloud.yaml

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
      with:
        token: ${{ secrets.BOT_GITHUB_TOKEN }}
        commit-message: Upgrade gcloud CLI to ${{ steps.release.outputs.tag }}
        committer: GitHub <noreply@github.com>
        signoff: true
        branch: upgrade-gcloud
        title: Upgrade gcloud CLI to ${{ steps.release.outputs.tag }}
        body: |
          Automated gcloud CLI upgrade to `${{ steps.release.outputs.tag }}`.

          Image: `google/cloud-sdk:${{ steps.release.outputs.tag }}`

          Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
