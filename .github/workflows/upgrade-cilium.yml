# Copyright 2025 Matheus Pimenta.
# SPDX-License-Identifier: AGPL-3.0

name: upgrade-cilium

on:
  schedule:
  - cron: "0 8 * * 1" # every Monday
  workflow_dispatch:

jobs:
  upgrade:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        token: ${{ secrets.BOT_GITHUB_TOKEN }}
        persist-credentials: false

    - name: Get latest Cilium v1.x release
      id: release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        tag=$(gh api repos/cilium/cilium/releases \
          --jq '[.[] | select(.prerelease == false and (.tag_name | startswith("v1.")))][0].tag_name')
        echo "tag=$tag" >> "$GITHUB_OUTPUT"

    - name: Update Makefile
      env:
        TAG: ${{ steps.release.outputs.tag }}
      run: |
        version="${TAG#v}"
        sed -i "s/^CILIUM_VERSION ?= .*/CILIUM_VERSION ?= ${version}/" Makefile

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
      with:
        token: ${{ secrets.BOT_GITHUB_TOKEN }}
        commit-message: Upgrade Cilium to ${{ steps.release.outputs.tag }}
        committer: GitHub <noreply@github.com>
        signoff: true
        branch: upgrade-cilium
        title: Upgrade Cilium to ${{ steps.release.outputs.tag }}
        body: |
          Automated Cilium upgrade to `${{ steps.release.outputs.tag }}`.

          Release: https://github.com/cilium/cilium/releases/tag/${{ steps.release.outputs.tag }}

          Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
