# Copyright 2025 Matheus Pimenta.
# SPDX-License-Identifier: AGPL-3.0

# Build stage
FROM golang:1.25.4-alpine3.21 AS builder

RUN apk add --no-cache clang llvm bpftool libbpf-dev

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY main.go ./
COPY ./api/ ./api/
COPY ./internal/ ./internal/
COPY ./ebpf/ ./ebpf/

RUN go generate ./internal/redirect
RUN go test -c github.com/matheuscscp/gke-metadata-server/internal/server

# Runtime stage
FROM alpine:3.22

WORKDIR /app

# Copy only the compiled test binary
COPY --from=builder /app/server.test ./

CMD [ "sh", "-c", "sleep 2 && ./server.test -test.v" ]
